#!/bin/bash

TEST_SERVER=ti08test
TI_DIR=/TI-08

cd $TI_DIR/Client/build/IA/Client/bin
cvs -q update

scp iadar iavirus $TEST_SERVER:/IA/tmp

for X in "pptest m3iadm" "pptest m3iagpp" "secrettest m3iagsec" "striketest m3iagstk" "scitest m3iagsci"; do
    TEST_HOST=`echo "$X" | cut -d ' ' -f 1`
    IOP_HOST=`echo "$X" | cut -d ' ' -f 2`

    if [ "$1" = "" -o "$1" = "$IOP_HOST" ]; then
        echo
        echo "-- $IOP_HOST --"

        if [ $IOP_HOST != m3iagsec ]; then
            ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST service iadar stop
        fi

        ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST service iavirus stop
        ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST service iapwm   stop

        ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST mount -o remount,rw /
        ssh $TEST_SERVER ssh $TEST_HOST scp /IA/tmp/ia{dar,virus,pwm} $IOP_HOST:/IA/Client/bin
        ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST mount -o remount,ro /

        ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST service iavirus start
        ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST service iapwm   start

        if [ $IOP_HOST != m3iagsec ]; then
            ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST service iadar start
        fi
    fi
done

ssh $TEST_SERVER rm -f /IA/tmp/ia{dar,virus,pwm}
