#!/bin/bash

TEST_SERVER=ti08test
TI_DIR=/TI-08

cd $TI_DIR/Client/build
cvs -q update makeTar installClient

./makeTar /tmp/iaclient.tar.gz
scp installClient /tmp/iaclient.tar.gz $TEST_SERVER:/IA/tmp
rm -f /tmp/iaclient.tar.gz

for X in "pptest m3iadm" "pptest m3iagpp" "secrettest m3iagsec" "striketest m3iagstk" "scitest m3iagsci"; do
    TEST_HOST=`echo "$X" | cut -d ' ' -f 1`
    IOP_HOST=`echo "$X" | cut -d ' ' -f 2`

    if [ "$1" = "" -o "$1" = "$IOP_HOST" ]; then
        echo
        echo "-- $IOP_HOST --"

        ssh $TEST_SERVER ssh $TEST_HOST scp /IA/tmp/installClient /IA/tmp/iaclient.tar.gz $IOP_HOST:/tmp
        ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST /tmp/installClient /tmp/iaclient.tar.gz
        ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST rm -f /tmp/installClient /tmp/iaclient.tar.gz
        ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST service iavirus start
        ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST service iapwm   start

        if [ $IOP_HOST = m3iagsec ]; then
            ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST mount -o remount,rw /
            ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST chkconfig iadar off
            ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST mount -o remount,ro /
        else
            ssh $TEST_SERVER ssh $TEST_HOST ssh $IOP_HOST service iadar start
        fi
    fi
done

ssh $TEST_SERVER rm -f /IA/tmp/installClient /IA/tmp/iaclient.tar.gz
